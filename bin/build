#!/bin/bash
# Build the project for development.
# All command-line arguments are passed to the executed `cargo` command.
# Optional environment variables:
#   $RUN_NEW_TERMINAL
#     If this variable is not `0` or empty,
#     then the cargo command is executed in a new terminal.
#     DEFAULT: ""
#   $RUN_FEATURES
#     Comma-separated list of features to be build with.
#     DEFAULT: "nightly"

# shellcheck source=./util.sh
_dir="$( dirname "$0" )"
[ -f "${_dir}/util.sh" ] || bash "${_dir}/download-util.sh" || exit 1
source "${_dir}/util.sh"
unset _dir

LOGFILE="${ROOT}/logs/$( basename "$0" ).log"
RUST_VERSION="nightly-2019-03-01"

function build {
  check "cargo"
  local features_str
  local features=("$RUN_FEATURES")
  features_str="$( join_by ',' "${features[@]}" )"
  local cmd="cargo +$RUST_VERSION run --features $features_str $*"
  local run_msg
  run_msg="$( colored "$COLOR_MSG_STRONG" "RUNNING:" ) $( colored "$COLOR_CODE" "$cmd" )"
  echo -e "$run_msg"
  if should_run_in_terminal; then
    run_terminal "$cmd"
  else
    $cmd
  fi
}

[ -z "$RUN_FEATURES" ] && RUN_FEATURES="nightly"

build "$@"
